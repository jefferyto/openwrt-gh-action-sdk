name: "OpenWrt SDK"
description: "Build OpenWrt packages via the SDK"
author: aparcar
runs:
  using: 'composite'
  steps:
    - run: echo "ARTIFACTS_DIR=${ARTIFACTS_DIR:-$GITHUB_WORKSPACE}" >> $GITHUB_ENV
      shell: bash
    - run: echo "FEED_DIR=${FEED_DIR:-$GITHUB_WORKSPACE}" >> $GITHUB_ENV
      shell: bash
    - run: sudo chown -R 1000:1000 $ARTIFACTS_DIR $FEED_DIR
      shell: bash
    - run: docker build --build-arg CONTAINER --build-arg ARCH -t sdk $GITHUB_ACTION_PATH
      shell: bash
    - run: |
        docker run --rm \
          --env BUILD_LOG \
          --env EXTRA_FEEDS \
          --env FEEDNAME \
          --env IGNORE_ERRORS \
          --env KEY_BUILD \
          --env NO_DEFAULT_FEEDS \
          --env NO_REFRESH_CHECK \
          --env NO_SHFMT_CHECK \
          --env PACKAGES \
          --env V \
          -v $ARTIFACTS_DIR:/artifacts \
          -v $FEED_DIR:/feed \
          sdk
      shell: bash
    - run: sudo chown -R --reference=$ARTIFACTS_DIR/.. $ARTIFACTS_DIR
      shell: bash
    - run: sudo chown -R --reference=$FEED_DIR/.. $FEED_DIR
      shell: bash
